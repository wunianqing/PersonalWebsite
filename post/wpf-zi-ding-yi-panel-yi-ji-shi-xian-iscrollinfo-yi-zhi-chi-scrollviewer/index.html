<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">

<title>理想乡</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

<meta name="description" content="远离喧嚣，静下心来感受世界"/>
<meta name="keywords" content="远离喧嚣，静下心来感受世界"/>

<!-- Place favicon.ico and apple-touch-icon.png in the root directory -->
<link rel="shortcut icon" href="https://www.avaloninparadise.cn/favicon.ico">

<link rel="stylesheet" href="https://www.avaloninparadise.cn/styles/main.css">

<!-- Modernizr JS -->
<script src="https://www.avaloninparadise.cn/media/scripts/modernizr-2.6.2.min.js"></script>
<!-- FOR IE9 below -->
<!--[if lt IE 9]>
<scripts src="https://www.avaloninparadise.cn/media/scripts/respond.min.js"></scripts>
<![endif]-->

<!-- Comment -->

    
        <link href="https://cdn.bootcss.com/gitalk/1.5.0/gitalk.min.css" rel="stylesheet">
    

    



<!-- katex -->
<!--<link href="https://cdn.bootcss.com/KaTeX/0.11.1/katex.min.css" rel="stylesheet">-->

<link href="https://cdn.bootcss.com/font-awesome/5.11.2/css/all.min.css" rel="stylesheet">



</head>
<body>
    <div id="fh5co-offcanvas">
    <a href="#!" class="fh5co-close-offcanvas js-fh5co-close-offcanvas">
        <span><i class="icon-cross3"></i> <span>Close</span></span>
    </a>
    <div class="fh5co-bio">
        <figure>
            <img src="https://www.avaloninparadise.cn/images/avatar.png" alt="理想乡"
                 class="img-responsive">
        </figure>
        <a href="https://www.avaloninparadise.cn/post/about/"><h3 class="heading">ABOUT ME</h3></a>
        <h2>理想乡</h2>
        <p>远离喧嚣，静下心来感受世界</p>
        <ul class="fh5co-social">
            
                <li>
                    
                </li>
            
                <li>
                    
                </li>
            
                <li>
                    
                </li>
            
                <li>
                    
                </li>
            
                <li>
                    
                </li>
            
        </ul>
    </div>

    <div class="fh5co-menu">

        <!-- 标签 -->
        <div class="fh5co-box">
            <a href="https://www.avaloninparadise.cn/tags/"><h3 class="heading">👉标签</h3></a>
            <ul>
                
                    <li><a href="https://www.avaloninparadise.cn/tag/Sy_-0SFnj/">Network Prograomming</a></li>
                
                    <li><a href="https://www.avaloninparadise.cn/tag/2ttYE691-/">代码记录</a></li>
                
                    <li><a href="https://www.avaloninparadise.cn/tag/5CXSWzvUJ/">C#</a></li>
                
                    <li><a href="https://www.avaloninparadise.cn/tag/Xr1Kblx7AI/">EventTracing</a></li>
                
                    <li><a href="https://www.avaloninparadise.cn/tag/n5lcfqYL4g/">Tricks</a></li>
                
                    <li><a href="https://www.avaloninparadise.cn/tag/UEkd_a4G4/">WPF</a></li>
                
            </ul>
        </div>
    </div>
</div>

<header id="fh5co-header">
    <div class="container-fluid">
        <div class="row">
            <a href="#" class="js-fh5co-nav-toggle fh5co-nav-toggle"><i></i></a>
            <ul class="fh5co-social">
                
                    <li>
                        <a href="/"
                        
                        >
                            首页
                        </a>
                    </li>
                
                    <li>
                        <a href="/archives"
                        
                        >
                            归档
                        </a>
                    </li>
                
                    <li>
                        <a href="/tags"
                        
                        >
                            标签
                        </a>
                    </li>
                
                    <li>
                        <a href="/post/about"
                        
                        >
                            关于
                        </a>
                    </li>
                
            </ul>
            <div class="col-lg-12 col-md-12 text-center">
                <h1 id="fh5co-logo">
                    <a href="https://www.avaloninparadise.cn">理想乡 </a>
                </h1>
            </div>
        </div>
    </div>
</header>


    <!--  <a href="#" class="fh5co-post-prev"><span>👈 Prev</span></a>-->
    <!--  <a href="#" class="fh5co-post-next"><span>Next 👉</span></a>-->

    <!-- 等gridea出自定义页面功能再优化一下 -->
    
        <div class="container-fluid">
    <div class="row fh5co-post-entry single-entry">
        <article class="col-lg-8 col-lg-offset-2 col-md-8 col-md-offset-2 col-sm-8 col-sm-offset-2 col-xs-12 col-xs-offset-0">
            <figure class="animate-box">
                
                    <img src="https://www.avaloninparadise.cn/post-images/wpf-zi-ding-yi-panel-yi-ji-shi-xian-iscrollinfo-yi-zhi-chi-scrollviewer.jpg" alt="WPF 自定义Panel以及实现IScrollInfo以支持ScrollViewer" class="img-responsive">
                
            </figure>
            <span class="fh5co-meta animate-box">
                
            </span>
            <h2 class="fh5co-article-title animate-box">WPF 自定义Panel以及实现IScrollInfo以支持ScrollViewer</h2>
            <ol class="breadcrumb fh5co-meta fh5co-date animate-box" style="margin-bottom:0; background-color:#f8f9fa">
                <li>2020-01-08</li>
                <li>1626字</li>
                <li>7 min read</li>
            </ol>

            <div class="col-lg-12 col-lg-offset-0 col-md-12 col-md-offset-0 col-sm-12 col-sm-offset-0 col-xs-12 col-xs-offset-0 text-left content-article">
                <div class="row">
                    <div class="col-md-12 animate-box post-content">
                        <p> <p>本文主要介绍了一下内容。</p>
<ol>
<li>什么是Panel。为什么要使用自定义Panel。</li>
<li>如何实现自动一Panel。</li>
<li>如何实现IScrollInfo。</li>
</ol>
<h2 id="什么是panel">什么是Panel</h2>
<p>下图为官方文档中给出的Panel继承关系。<br>
<img src="https://www.avaloninparadise.cn/post-images/1578462264146.png" alt="Panel的继承关系" loading="lazy"><br>
我们可以看到，Panel是日常使用的布局类的基类。在WPF中，使用Panel类来对界面进行布局。</p>
<h2 id="为什么要使用自定义panel">为什么要使用自定义Panel</h2>
<p>在上面的Panel继承关系图中我们可以看到，默认提供的布局类是有限的。如果他们满足不了我们的布局需求，我们就需要自定义Panel。比如，实现文件浏览器中平铺的布局。</p>
<h2 id="如何实现自定义panel">如何实现自定义Panel</h2>
<p>首先需要知道一个Panel的完整布局过程。<br>
<img src="https://www.avaloninparadise.cn/post-images/1578463198629.png" alt="Panel布局时序" loading="lazy"><br>
如图，在父节点决定重新布局时，会进行一系列的操作。对于Panel而言，核心的是两个步骤。这两个步骤的实现是通过两个核心的方法实现的，<a href="https://docs.microsoft.com/en-us/dotnet/api/system.windows.frameworkelement.measureoverride?view=netframework-4.8#System_Windows_FrameworkElement_MeasureOverride_System_Windows_Size_"><code>MeasureOverride</code></a>以及<a href="https://docs.microsoft.com/en-us/dotnet/api/system.windows.frameworkelement.arrangeoverride?view=netframework-4.8#System_Windows_FrameworkElement_ArrangeOverride_System_Windows_Size_"><code>ArrangeOverride</code></a>。</p>
<h3 id="测量measure">测量Measure</h3>
<p>这一步是对自身大小进行一个预估。</p>
<pre><code class="language-c#">Size MeasureOverride(Size availableSize)
</code></pre>
<p><code>MeasureOverride</code>的唯一参数是<code>Size</code>类型的，这个参数代表着上层预计给你的布局空间。也就是说，预估情况下，你能够使用的大小。比如<code>ContentControl</code>这种承载类的控件，会给你一个无限大的范围，由你自身计算你会使用的大小，返回给上层。</p>
<blockquote>
<p>这里虽然给你一个大小无限的参数，但是你却不能返回一个大小无限的Size。</p>
</blockquote>
<p>那么如何进行自身使用大小的计算呢？简单来说，就是问一下Panel自身承载的所有控件需要的大小，然后对这些控件按布局排列之后，需要的大小就是自身的大小。</p>
<blockquote>
<p>举个例子，StackPanel纵向排列的情况下，有4个预计大小为400 * 300的Children。那么这个Panel本身需要的大小就是400 * 1200。这个1200 = 300 * 4，因为是纵向排列。如果换成横向排列，那么需要的大小是1600 * 300。</p>
</blockquote>
<p>通常情况下，你的MeasureOverride会写成这个样子。</p>
<pre><code class="language-c#">        protected override Size MeasureOverride(Size availableSize)
        {
            var result = new Size();
            foreach (UIElement child in InternalChildren)
            {
                //询问包含的控件需要的大小。预期的大小会保存在DesiredSize中。
                child.Measure(availableSize);
                //根据布局方式，计算实际使用的大小。这一部分根据你的需求进行编写
                result.Width = Math.Max(result.Width, child.DesiredSize.Width);
                result.Height += child.DesiredSize.Height;
            }
            return result;
        }
</code></pre>
<h3 id="布局arrange">布局Arrange</h3>
<p>这一步是对控件进行布局，会实际应用到界面上。上一步只是进行一个预估，如果你的上一步乱写，而你在这一步进行了正确的布局，你也很大概率会得到一个正确的界面布局。</p>
<pre><code class="language-c#">Size ArrageOverride(Size finalSize)
</code></pre>
<p>同Measure，这一步的finalSize是你实际布局时可以用的大小。<strong>通常情况</strong>下不会是无限大。而且这个大小会跟上一步有管关，有时就直接是上一步的返回值。同样的，这个函数的返回值就是Panel在界面上的最终大小。<br>
在这一步，你需要做的是根据可用大小，以及每个控件希望的大小，来对控件进行布局。<br>
通常情况下，你的函数会写得像这样。</p>
<pre><code class="language-c#">        protected override Size ArrangeOverride(Size availableSize)
        {
            var result = new Size();
            var offset = new Point();
            foreach (UIElement child in InternalChildren)
            {
                //根据布局方式计算出当前控件的布局位置
                var rect = new Rect(offset, child.DesiredSize);
                offset.Y += rect.Height;
                // 计算完成后应该更新最终要使用的大小
                result.Height += rect.Height;
                
                //布局控件
                child.Arrange(rect);
            }
            return result;
        }
</code></pre>
<h2 id="实现iscrollinfo">实现IScrollInfo</h2>
<p>按照之前的步骤进行，我们就能实现一个可用的自定义Panel。不过一旦我们将Panel置于<code>ScrollViewer</code>中，我们会发现Panel会产生很诡异的布局，甚至可能会直接运行时报错。这是因为<code>ScrollViewer</code>的特殊性。该控件认为其内部能够承载无限大的控件，但是可视区域有限。通过滚动条来调整可视区域以观察内部承载的内容。所以，<code>MeasureOverride</code>以及<code>ArrageOverride</code>都会收到无限大的参数。这时候我们的布局计算就很难进行，因为我们并不知道可视区域在哪。此时，我们需要实现<code>IScrollInfo</code>来支持<code>ScrollViewer</code>。<br>
<img src="https://www.avaloninparadise.cn/post-images/1579154053887.png" alt="IScrollInfo" loading="lazy"><br>
如上图，<code>IScrollInfo</code>还是算一个比较大的接口。所以让我们来对其进行一下分类整理。<br>
从属性上来看，有好几个成对出现的。唯一一个单独的就是<code>ScrollOwner</code>，这个很好理解。之前也解释过，为什么需要用到<code>IScrollInfo</code>，就是为了支持<code>ScrollViewer</code>。所以这里的<code>ScrollOwner</code>就是Host。</p>
<table>
<thead>
<tr>
<th>类别</th>
<th>属性1</th>
<th>属性2</th>
</tr>
</thead>
<tbody>
<tr>
<td>Extent</td>
<td>ExtentWidth</td>
<td>ExtentHeight</td>
</tr>
<tr>
<td>Viewport</td>
<td>ViewportWidth</td>
<td>ViewportHeight</td>
</tr>
<tr>
<td>Offset</td>
<td>HorizontalOffset</td>
<td>VerticalOffset</td>
</tr>
<tr>
<td>CanScroll</td>
<td>CanHorizontallyScroll</td>
<td>CanVerticallyScroll</td>
</tr>
</tbody>
</table>
<p>首先需要明确一件事，这些属性到底是给谁用的。答案是，这些属性都是给<code>ScrollViewer</code>用的。没有这些属性，我们也能完成控件的布局。这些属性都是为了正确地显示滚动条而存在的。故，每次更改这些值之后，需要调用<code>ScrollOwner.InvalidateScrollInfo()</code>来通知<code>ScrollViewer</code>更新滚动条。<br>
首先最好理解的就是CanScroll的这一对了。很直白。就是能不能在某个方向上进行滚动。<br>
剩下的三对属性其实是组合使用的。<strong>Extent表示实际内容的大小，Viewport表示可视区域的大小，Offset表示可视区域的偏移量。</strong><br>
<img src="https://www.avaloninparadise.cn/post-images/1579156736387.png" alt="示意图" loading="lazy"><br>
如图所示，假设我们有四个控件，都是400*350的大小,可视区域也是400*350，已经将可视区域滚动到显示第二个控件。那么我们的Extent的大小就是400*1400，Viewport是400*350，Offset是0*350。是不是能够理解这三对属性了呢。<br>
我们的<code>ArrangeOverride</code>也需要进行一些调整。<strong>对控件进行布局的时候，需要减去Offset</strong>。对于上面的一张图，控件分别的布局是：</p>
<ol>
<li><code>control1.Arrage(new Rect(0 - HorizontalOffset, 0 - VerticalOffset, 400, 350));</code></li>
<li><code>control2.Arrage(new Rect(0 - HorizontalOffset, 350 - VerticalOffset, 400, 350));</code></li>
<li><code>control3.Arrage(new Rect(0 - HorizontalOffset, 700 - VerticalOffset, 400, 350));</code></li>
<li><code>control4.Arrage(new Rect(0 - HorizontalOffset, 1050 - VerticalOffset, 400, 350));</code><br>
然后是，在完成布局后，更新Extent以及Viewport的值。</li>
</ol>
<blockquote>
<p>这里其实还需要判断Offset是否超界，超界后应对其校正。</p>
</blockquote>
<p>那么剩下的方法其实就很好处理了。无非就是更改Offset，然后重新布局。以<code>LineUp</code>为例：</p>
<pre><code class="language-c#">public void LineUp()
{
    _offset += new Vector(0, -20);
    //校正Offset以避免超界
    CorrectOffset();
    InvalidateArrange();
}
</code></pre>
 </p>
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-12 animate-box">
                        
                            <div class="next-post">
                                <div class="next">下一篇</div>
                                <a href="https://www.avaloninparadise.cn/post/wpf-shi-yong-idataerrorinfo-jie-kou-jin-xing-shu-ju-xiao-yan/">
                                    <h3 class="post-title">
                                        WPF使用IDataErrorInfo接口进行数据校验
                                    </h3>
                                </a>
                            </div>
                        
                    </div>
                </div>

                <div class="row">
    <div class="col-md-12 animate-box">
        
            
                <div id="gitalk-container"></div>
            

            
        
    </div>
</div>

            </div>

        </article>
    </div>
</div>

    

    <!-- 返回顶部 -->
    <div class="back-to-top">
    
        <a href="#!" id="tool-toc" class="hidden-xs hidden-sm">
            <i class="fa fa-map"></i>
        </a>
        <br>
    
    <a href="#top" class="hidden-xs hidden-sm"><i class="fa fa-paper-plane"></i></a>
</div>

<div class="post-toc animated fadeInRight hidden-xs hidden-sm" style="display: none;">
    <ul class="markdownIt-TOC">
<li>
<ul>
<li><a href="#%E4%BB%80%E4%B9%88%E6%98%AFpanel">什么是Panel</a></li>
<li><a href="#%E4%B8%BA%E4%BB%80%E4%B9%88%E8%A6%81%E4%BD%BF%E7%94%A8%E8%87%AA%E5%AE%9A%E4%B9%89panel">为什么要使用自定义Panel</a></li>
<li><a href="#%E5%A6%82%E4%BD%95%E5%AE%9E%E7%8E%B0%E8%87%AA%E5%AE%9A%E4%B9%89panel">如何实现自定义Panel</a>
<ul>
<li><a href="#%E6%B5%8B%E9%87%8Fmeasure">测量Measure</a></li>
<li><a href="#%E5%B8%83%E5%B1%80arrange">布局Arrange</a></li>
</ul>
</li>
<li><a href="#%E5%AE%9E%E7%8E%B0iscrollinfo">实现IScrollInfo</a></li>
</ul>
</li>
</ul>

</div>


    
<footer id="fh5co-footer">
  <p><a href="https://beian.miit.gov.cn/">蜀ICP备18034189号-1</a></p>
</footer>


    <!-- jQuery -->
<script src="https://www.avaloninparadise.cn/media/scripts/jquery.min.js"></script>
<!-- img lazy load -->
<script src="https://www.avaloninparadise.cn/media/scripts/jquery.lazyload.min.js"></script>
<!-- jQuery Easing -->
<script src="https://www.avaloninparadise.cn/media/scripts/jquery.easing.1.3.js"></script>
<!-- Bootstrap -->
<script src="https://www.avaloninparadise.cn/media/scripts/bootstrap.min.js"></script>
<!-- Waypoints -->
<script src="https://www.avaloninparadise.cn/media/scripts/jquery.waypoints.min.js"></script>
<!-- Main JS -->
<script src="https://www.avaloninparadise.cn/media/scripts/main.js"></script>
<!-- Md5 Min JS -->
<script src="https://www.avaloninparadise.cn/media/scripts/md5.min.js"></script>
<!-- katex -->
<!--<script src="https://cdn.bootcss.com/KaTeX/0.11.1/katex.min.js"></script>-->
<!-- highlight -->
<script src="https://cdn.bootcss.com/highlight.js/9.15.8/highlight.min.js"></script>


<script type="application/javascript">
    // 代码高亮
    hljs.initHighlightingOnLoad();

    // img 懒加载
    $(function () {
        $("img.lazy").lazyload({
            effect: "fadeIn",  // 懒加载动画
            threshold: 180  // 在图片距离屏幕180px时提前载入
        });
        // tooltip
        $('[data-toggle="tooltip"]').tooltip();

        // 目录
        $('#tool-toc').click(function () {
            $('.post-toc').toggle();
        });
    });

    
</script>



    
        <script src="https://cdn.bootcss.com/gitalk/1.5.0/gitalk.min.js"></script>
        <script>

            var gitalk = new Gitalk({
                clientID: 'da4ce1950c04e8a84b86',
                clientSecret: '218cc92d3af98096d7e1754ffae1bb8580b7ba65',
                repo: 'https://github.com/wunianqing/GittalkForMyBlog.git',
                owner: 'yzhou',
                admin: ['yzhou'],
                id: md5(location.pathname),      // Ensure uniqueness and length less than 50
                distractionFreeMode: false  // Facebook-like distraction free mode
            })

            gitalk.render('gitalk-container')

        </script>
    

    




</body>
</html>
