<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">

<title>ç†æƒ³ä¹¡</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

<meta name="description" content="è¿œç¦»å–§åš£ï¼Œé™ä¸‹å¿ƒæ¥æ„Ÿå—ä¸–ç•Œ"/>
<meta name="keywords" content="è¿œç¦»å–§åš£ï¼Œé™ä¸‹å¿ƒæ¥æ„Ÿå—ä¸–ç•Œ"/>

<!-- Place favicon.ico and apple-touch-icon.png in the root directory -->
<link rel="shortcut icon" href="https://www.avaloninparadise.cn/favicon.ico">

<link rel="stylesheet" href="https://www.avaloninparadise.cn/styles/main.css">

<!-- Modernizr JS -->
<script src="https://www.avaloninparadise.cn/media/scripts/modernizr-2.6.2.min.js"></script>
<!-- FOR IE9 below -->
<!--[if lt IE 9]>
<scripts src="https://www.avaloninparadise.cn/media/scripts/respond.min.js"></scripts>
<![endif]-->

<!-- Comment -->

    
        <link href="https://cdn.bootcss.com/gitalk/1.5.0/gitalk.min.css" rel="stylesheet">
    

    



<!-- katex -->
<!--<link href="https://cdn.bootcss.com/KaTeX/0.11.1/katex.min.css" rel="stylesheet">-->

<link href="https://cdn.bootcss.com/font-awesome/5.11.2/css/all.min.css" rel="stylesheet">



</head>
<body>
    <div id="fh5co-offcanvas">
    <a href="#!" class="fh5co-close-offcanvas js-fh5co-close-offcanvas">
        <span><i class="icon-cross3"></i> <span>Close</span></span>
    </a>
    <div class="fh5co-bio">
        <figure>
            <img src="https://www.avaloninparadise.cn/images/avatar.png" alt="ç†æƒ³ä¹¡"
                 class="img-responsive">
        </figure>
        <a href="https://www.avaloninparadise.cn/post/about/"><h3 class="heading">ABOUT ME</h3></a>
        <h2>ç†æƒ³ä¹¡</h2>
        <p>è¿œç¦»å–§åš£ï¼Œé™ä¸‹å¿ƒæ¥æ„Ÿå—ä¸–ç•Œ</p>
        <ul class="fh5co-social">
            
                <li>
                    
                </li>
            
                <li>
                    
                </li>
            
                <li>
                    
                </li>
            
                <li>
                    
                </li>
            
                <li>
                    
                </li>
            
        </ul>
    </div>

    <div class="fh5co-menu">

        <!-- æ ‡ç­¾ -->
        <div class="fh5co-box">
            <a href="https://www.avaloninparadise.cn/tags/"><h3 class="heading">ğŸ‘‰æ ‡ç­¾</h3></a>
            <ul>
                
                    <li><a href="https://www.avaloninparadise.cn/tag/2ttYE691-/">ä»£ç è®°å½•</a></li>
                
                    <li><a href="https://www.avaloninparadise.cn/tag/5CXSWzvUJ/">C#</a></li>
                
                    <li><a href="https://www.avaloninparadise.cn/tag/Xr1Kblx7AI/">EventTracing</a></li>
                
                    <li><a href="https://www.avaloninparadise.cn/tag/n5lcfqYL4g/">Tricks</a></li>
                
                    <li><a href="https://www.avaloninparadise.cn/tag/UEkd_a4G4/">WPF</a></li>
                
            </ul>
        </div>
    </div>
</div>

<header id="fh5co-header">
    <div class="container-fluid">
        <div class="row">
            <a href="#" class="js-fh5co-nav-toggle fh5co-nav-toggle"><i></i></a>
            <ul class="fh5co-social">
                
                    <li>
                        <a href="/"
                        
                        >
                            é¦–é¡µ
                        </a>
                    </li>
                
                    <li>
                        <a href="/archives"
                        
                        >
                            å½’æ¡£
                        </a>
                    </li>
                
                    <li>
                        <a href="/tags"
                        
                        >
                            æ ‡ç­¾
                        </a>
                    </li>
                
                    <li>
                        <a href="/post/about"
                        
                        >
                            å…³äº
                        </a>
                    </li>
                
            </ul>
            <div class="col-lg-12 col-md-12 text-center">
                <h1 id="fh5co-logo">
                    <a href="https://www.avaloninparadise.cn">ç†æƒ³ä¹¡ </a>
                </h1>
            </div>
        </div>
    </div>
</header>


    <!--  <a href="#" class="fh5co-post-prev"><span>ğŸ‘ˆ Prev</span></a>-->
    <!--  <a href="#" class="fh5co-post-next"><span>Next ğŸ‘‰</span></a>-->

    <!-- ç­‰grideaå‡ºè‡ªå®šä¹‰é¡µé¢åŠŸèƒ½å†ä¼˜åŒ–ä¸€ä¸‹ -->
    
        <div class="container-fluid">
    <div class="row fh5co-post-entry single-entry">
        <article class="col-lg-8 col-lg-offset-2 col-md-8 col-md-offset-2 col-sm-8 col-sm-offset-2 col-xs-12 col-xs-offset-0">
            <figure class="animate-box">
                
                    <img src="https://www.avaloninparadise.cn/post-images/shi-yong-wei-ruan-ti-gong-de-settings-yi-ji-zi-ding-yi-settingsprovider.jpg" alt="ä½¿ç”¨å¾®è½¯æä¾›çš„Settingsä»¥åŠè‡ªå®šä¹‰SettingsProvider" class="img-responsive">
                
            </figure>
            <span class="fh5co-meta animate-box">
                
                    <div class="tag-container">
                        
                            <a href="https://www.avaloninparadise.cn/tag/UEkd_a4G4/" class="tag">WPF, </a>
                        
                    </div>
                
            </span>
            <h2 class="fh5co-article-title animate-box">ä½¿ç”¨å¾®è½¯æä¾›çš„Settingsä»¥åŠè‡ªå®šä¹‰SettingsProvider</h2>
            <ol class="breadcrumb fh5co-meta fh5co-date animate-box" style="margin-bottom:0; background-color:#f8f9fa">
                <li>2019-10-22</li>
                <li>1896å­—</li>
                <li>10 min read</li>
            </ol>

            <div class="col-lg-12 col-lg-offset-0 col-md-12 col-md-offset-0 col-sm-12 col-sm-offset-0 col-xs-12 col-xs-offset-0 text-left content-article">
                <div class="row">
                    <div class="col-md-12 animate-box post-content">
                        <p> <h1 id="å‰è¨€">å‰è¨€</h1>
<p>åœ¨ç¨‹åºä¸­ï¼Œéš¾å…ä¼šç”¨åˆ°é…ç½®æ–‡ä»¶ã€‚å¦‚ä½•å¤„ç†é…ç½®æ–‡ä»¶é—®é¢˜ï¼Œæœ‰è®¸è®¸å¤šå¤šçš„è§£å†³æ–¹æ¡ˆã€‚ç®€å•çš„å°±æ˜¯ç›´æ¥åœ¨app.configé‡Œé¢åŠ ä¸€æ¡ï¼Œç„¶åè¯»å–ã€‚å¤æ‚ä¸€äº›çš„ï¼Œå¯èƒ½éœ€è¦è‡ªå·±å»å®šä¹‰æ ¼å¼ï¼Œå­˜å‚¨ä½ç½®ã€‚å¾®è½¯ä¸ºæˆ‘ä»¬æä¾›äº†ä¸€ä¸ªæ–¹æ¡ˆï¼Œå°±æ˜¯åœ¨é¡¹ç›®ä¸­çš„<code>Settings</code>ã€‚<br>
<img src="https://upload-images.jianshu.io/upload_images/1802880-bbfc08a80494db97.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="Settings" loading="lazy"></p>
<h1 id="ä½¿ç”¨settings">ä½¿ç”¨Settings</h1>
<p><code>Settings</code>ä¸ºæˆ‘ä»¬æä¾›äº†è®¾ç½®ç•Œé¢ï¼Œæ–¹ä¾¿æ“ä½œã€‚ä½¿ç”¨èµ·æ¥éå¸¸ç®€å•ã€‚<br>
å¦‚æœä½ æ–°å»ºä¸€ä¸ªWPFé¡¹ç›®ï¼Œæ¨¡æ¿ä¸­å…¶å®é»˜è®¤å°±å¸¦æœ‰ä¸€ä¸ª<code>Settings</code>æ–‡ä»¶ã€‚å°±åƒä¸Šä¸€èŠ‚ä¸­çš„æ’å›¾ä¸€æ ·ï¼Œå±•å¼€Proerptieså³å¯è§ã€‚ä½ ä¹Ÿå¯ä»¥åƒæ·»åŠ ä¸€èˆ¬çš„ç±»ä¸€æ ·æ·»åŠ æ–°çš„<code>Settings</code>æ–‡ä»¶ï¼Œåªéœ€è¦åœ¨æ·»åŠ æ–‡ä»¶çš„çª—å£ä¸­æ‰¾åˆ°<code>Settings</code>ç±»å‹ï¼Œæ·»åŠ å³å¯ã€‚<br>
<img src="https://upload-images.jianshu.io/upload_images/1802880-2589526e7f2cfbcf.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="æ·»åŠ æ–°çš„Settingsæ–‡ä»¶" loading="lazy"><br>
åŒå‡»<code>Settings</code>æ–‡ä»¶ï¼Œè¿›å…¥å¯è§†åŒ–ç¼–è¾‘ç•Œé¢ã€‚<br>
<img src="https://upload-images.jianshu.io/upload_images/1802880-59ae020a7d766b6f.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="å¯è§†åŒ–ç¼–è¾‘ç•Œé¢" loading="lazy"><br>
<img src="https://upload-images.jianshu.io/upload_images/1802880-68cb99eeca19151b.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="ç±»å‹é€‰æ‹©" loading="lazy"><br>
<img src="https://upload-images.jianshu.io/upload_images/1802880-1081d79f56e01259.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="ä½œç”¨èŒƒå›´é€‰æ‹©" loading="lazy"></p>
<p>ç¬¬ä¸€åˆ—æ˜¯è®¾ç½®é¡¹çš„åç§°ã€‚è¯¥å€¼ä½œä¸ºå°†æ¥åœ¨ç¨‹åºä¸­è·å–æˆ–è®¾ç½®æ­¤é¡¹è®¾ç½®æ—¶çš„é”®ã€‚<br>
ç¬¬äºŒåˆ—æ˜¯è®¾ç½®é¡¹çš„ç±»å‹ã€‚é»˜è®¤æœ‰å¾ˆå¤šçš„åŸºæœ¬ç±»å‹ï¼Œæ³¨æ„æœ€æœ‰ä¸€é¡¹ï¼Œæ˜¯å¯ä»¥é€‰æ‹©è‡ªå®šä¹‰ç±»å‹çš„ã€‚ä½†æ˜¯ä¹Ÿè¦æ”¯æŒåºåˆ—åŒ–çš„ç±»å‹æ‰è¡Œï¼Œå¦‚æœæ˜¯å¾ˆå¤æ‚çš„ç±»å‹ï¼Œéœ€è¦å¯¹å…¶æ·»åŠ åºåˆ—åŒ–å’Œååºåˆ—åŒ–çš„æ–¹æ³•ã€‚<br>
ç¬¬ä¸‰é¡¹æ˜¯è®¾ç½®é¡¹çš„ä½œç”¨èŒƒå›´ã€‚åªæœ‰ä¸¤ç§é€‰æ‹©ï¼ŒApplicationå’ŒUserã€‚å¦‚æœä½ é€‰æ‹©Applicationï¼Œé‚£ä¹ˆè¯¥è®¾ç½®é¡¹çš„å€¼ä¸èƒ½è¢«ä¿®æ”¹ã€‚å¦‚æœä½ é€‰æ‹©Userï¼Œè¯¥è®¾ç½®é¡¹å¯ä»¥è¢«ä¿®æ”¹ï¼Œä½†æ˜¯ä»…é’ˆå¯¹äºå½“å‰è®¡ç®—æœºç”¨æˆ·ç”Ÿæ•ˆã€‚<br>
ç¬¬å››é¡¹æ˜¯è®¾ç½®é¡¹çš„é»˜è®¤å€¼ã€‚è¿™ä¸ªæ²¡ä»€ä¹ˆå¥½è¯´çš„ï¼Œè®°å¾—é»˜è®¤å€¼è¦å’Œç±»å‹åŒ¹é…ï¼Œä¸ç„¶ä¼šç¼–è¯‘ä¸é€šè¿‡ã€‚</p>
<p>æ·»åŠ å®Œæˆåï¼Œè®°å¾—ç‚¹ä¸€ä¸‹ä¿å­˜ã€‚VSä¼šå¸®ä½ ç”Ÿæˆå¯¹åº”çš„ä»£ç ã€‚å¯¹åº”çš„ä»£ç ä½ å¯ä»¥åœ¨<code>Settings</code>æ–‡ä»¶å¯¹åº”çš„csæ–‡ä»¶ä¸­æ‰¾åˆ°ã€‚<br>
<img src="https://upload-images.jianshu.io/upload_images/1802880-6627dc5b7899fc55.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="ç”Ÿæˆçš„ä»£ç ä½ç½®" loading="lazy"><br>
å•é¡¹è®¾ç½®å¯¹åº”çš„ä»£ç ï¼š</p>
<pre><code class="language-c#">        [global::System.Configuration.UserScopedSettingAttribute()]
        [global::System.Diagnostics.DebuggerNonUserCodeAttribute()]
        [global::System.Configuration.DefaultSettingValueAttribute(&quot;123&quot;)]
        public string Setting {
            get {
                return ((string)(this[&quot;Setting&quot;]));
            }
            set {
                this[&quot;Setting&quot;] = value;
            }
        }
</code></pre>
<p>æˆªå›¾ä¸­çš„è®¾ç½®ç”Ÿæˆçš„å¯¹åº”ä»£ç ï¼š</p>
<pre><code class="language-c#">    [global::System.Runtime.CompilerServices.CompilerGeneratedAttribute()]
    [global::System.CodeDom.Compiler.GeneratedCodeAttribute(&quot;Microsoft.VisualStudio.Editors.SettingsDesigner.SettingsSingleFileGenerator&quot;, &quot;15.9.0.0&quot;)]
    internal sealed partial class Settings : global::System.Configuration.ApplicationSettingsBase {
        
        private static Settings defaultInstance = ((Settings)(global::System.Configuration.ApplicationSettingsBase.Synchronized(new Settings())));
        
        public static Settings Default {
            get {
                return defaultInstance;
            }
        }
        
        [global::System.Configuration.UserScopedSettingAttribute()]
        [global::System.Diagnostics.DebuggerNonUserCodeAttribute()]
        [global::System.Configuration.DefaultSettingValueAttribute(&quot;123&quot;)]
        public string Setting {
            get {
                return ((string)(this[&quot;Setting&quot;]));
            }
            set {
                this[&quot;Setting&quot;] = value;
            }
        }
    }
</code></pre>
<p>åœ¨CSä¸­ä½¿ç”¨è®¾ç½®å°±æ›´ç®€å•äº†ã€‚</p>
<pre><code class="language-c#">        static void Main(string[] args)
        {
            //è¯»å–è®¾ç½®
            var t = Properties.Settings.Default.Setting;
            Console.WriteLine(t);
            //æ›´æ–°è®¾ç½®
            Properties.Settings.Default.Setting = &quot;6666666&quot;;
            //ä¿å­˜è®¾ç½®
            Properties.Settings.Default.Save();
        }
</code></pre>
<p>å¦‚ä½•ä½¿ç”¨åˆ°æ­¤ç»“æŸã€‚</p>
<h1 id="å·¥ä½œæµç¨‹åŠåŸç†ç®€è¿°">å·¥ä½œæµç¨‹åŠåŸç†ç®€è¿°</h1>
<ol>
<li>å¯è§†åŒ–ç•Œé¢æ·»åŠ éœ€è¦çš„è®¾ç½®é¡¹ã€‚ä¿å­˜æ—¶ä¼šç”Ÿæˆå¯¹åº”çš„csæ–‡ä»¶ï¼ŒåŒæ—¶ï¼Œä¼šæœ‰å¯¹åº”çš„xmlå†…å®¹å†™å…¥app.configã€‚</li>
<li>æ‰§è¡Œåˆ°è¯»å–è®¾ç½®æ—¶ï¼Œä¼šæ ¹æ®è®¾ç½®é¡¹çš„ä½œç”¨èŒƒå›´ï¼Œå»è¯»å–ä¸åŒçš„é…ç½®æ–‡ä»¶ã€‚å¦‚æœæ²¡æœ‰è¯»å–åˆ°å€¼ï¼Œä¼šè¿”å›é»˜è®¤å€¼ã€‚æ‰§è¡Œåˆ°å†™å…¥è®¾ç½®æ—¶ï¼Œç”±äºåªæœ‰Userçš„ç±»å‹æ‰èƒ½å†™å…¥ï¼Œç³»ç»Ÿä¼šè°ƒç”¨é»˜è®¤çš„LocalFileSettingsProviderä¿å­˜åˆ°å½“å‰ç”¨æˆ·çš„AppData\Local\{ApplicationName}\{Version}\{ApplicationName+LocationHashValue}ã€‚</li>
</ol>
<p>åŸç†å…¶å®éå¸¸ç®€å•ã€‚æ¯æ¬¡è¯»æˆ–å†™éƒ½ç”Ÿæˆä¸€ä¸ª<code>SettingsProvider</code>çš„å®ä¾‹ï¼Œç„¶åé€šè¿‡è¿™ä¸ªå®ä¾‹è¿›è¡Œè¯»æˆ–è€…å†™ã€‚ä½ å¯ä»¥é€šè¿‡æ·»åŠ å±æ€§æ¥æŒ‡å®š<code>SettingsProvider</code>çš„ç±»å‹ã€‚é»˜è®¤ä¼šä½¿ç”¨<code>LocalFileSettingsProvider</code>ã€‚ç”±äº<code>LocalFileSettingsProvider</code>æ²¡æœ‰æä¾›ä¿®æ”¹ä¿å­˜è·¯å¾„çš„æ–¹æ³•ï¼Œæˆ‘ä»¬éœ€è¦è‡ªå®šä¹‰<code>SettingsProvider</code>æ¥ä¿®æ”¹ä¿å­˜è·¯å¾„ã€‚éœ€è¦å°†<code>[SettingsProvider(typeof(CustomProvider))]</code>æ·»åŠ åˆ°ç”Ÿæˆçš„csç±»ä¸Šã€‚</p>
<blockquote>
<p>å¾®è½¯è¡¨ç¤ºä¸æä¾›è·¯å¾„ä¿®æ”¹æ˜¯å‡ºäºå®‰å…¨è€ƒè™‘ã€‚å…·ä½“çš„å†…å®¹è¯·è‡ªè¡Œå‚é˜…å®˜æ–¹æ–‡æ¡£ã€‚</p>
</blockquote>
<h1 id="è‡ªå®šä¹‰settingsprovider">è‡ªå®šä¹‰SettingsProvider</h1>
<p>ç›´æ¥æä¾›ç»™å¤§å®¶ä¸€ä¸ªå¯ä»¥ç”¨çš„ã€‚è®²è§£æˆ‘æ”¾åœ¨åé¢ã€‚è¿™ä¸ªç±»æ˜¯æ‹”å¾®è½¯æºç åšçš„ã€‚</p>
<pre><code class="language-cs">    [
         PermissionSet(SecurityAction.LinkDemand, Name = &quot;FullTrust&quot;),
         PermissionSet(SecurityAction.InheritanceDemand, Name = &quot;FullTrust&quot;)
    ]
    public class CustomSettingsProvider : SettingsProvider
    {
        private const string UserSettingsGroupName = &quot;userSettings&quot;;
        private string _applicationName;
        public override string ApplicationName { get =&gt; _applicationName; set =&gt; _applicationName = value; }

        public override void Initialize(string name, NameValueCollection values)
        {
            if (String.IsNullOrEmpty(name))
            {
                name = &quot;CustomProvider&quot;;
            }

            base.Initialize(name, values);
        }

        private Configuration configuration;

        private void Open()
        {
            var fileMap = new ExeConfigurationFileMap
            {
                ExeConfigFilename = $&quot;{_applicationName}.exe.config&quot;,
                RoamingUserConfigFilename = Environment.GetFolderPath(Environment.SpecialFolder.ApplicationData) + &quot;\\&quot; + _applicationName + &quot;\\Settings\\user.config&quot;
            };
            configuration = ConfigurationManager.OpenMappedExeConfiguration(fileMap, ConfigurationUserLevel.PerUserRoaming);
        }

        [
         FileIOPermission(SecurityAction.Assert, AllFiles = FileIOPermissionAccess.PathDiscovery | FileIOPermissionAccess.Read),
         PermissionSet(SecurityAction.LinkDemand, Name = &quot;FullTrust&quot;),
         PermissionSet(SecurityAction.InheritanceDemand, Name = &quot;FullTrust&quot;)
        ]
        public override SettingsPropertyValueCollection GetPropertyValues(SettingsContext context, SettingsPropertyCollection collection)
        {
            Open();
            var settings = ReadSettingsFromFile(GetSectionName(context));
            var values = new SettingsPropertyValueCollection();
            foreach (SettingsProperty settingProperty in collection)
            {
                var value = new SettingsPropertyValue(settingProperty);
                if (settings.Contains(settingProperty.Name))
                {
                    var ss = (StoredSetting)settings[settingProperty.Name];
                    var valueString = ss.xmlNode.InnerXml;
                    if (ss.serializeAs == SettingsSerializeAs.String)
                    {
                        valueString = Escaper.Unescape(valueString);
                    }
                    value.SerializedValue = valueString;
                }
                else if (settingProperty.DefaultValue != null)
                {
                    value.SerializedValue = settingProperty.DefaultValue;
                }

                value.IsDirty = false;
                values.Add(value);
            }
            return values;
        }

        private XmlEscaper Escaper = new XmlEscaper();

        private IDictionary ReadSettingsFromFile(string sectionName)
        {
            IDictionary settings = new Hashtable();

            var sectionGroup = configuration.GetSectionGroup(UserSettingsGroupName);
            var section = sectionGroup.Sections[sectionName] as ClientSettingsSection;
            if (section != null)
            {
                foreach (SettingElement setting in section.Settings)
                {
                    settings[setting.Name] = new StoredSetting(setting.SerializeAs, setting.Value.ValueXml);
                }
            }

            return settings;
        }

        private string GetSectionName(SettingsContext context)
        {
            string groupName = (string)context[&quot;GroupName&quot;];
            string key = (string)context[&quot;SettingsKey&quot;];

            Debug.Assert(groupName != null, &quot;SettingsContext did not have a GroupName!&quot;);

            string sectionName = groupName;

            if (!String.IsNullOrEmpty(key))
            {
                sectionName = string.Format(CultureInfo.InvariantCulture, &quot;{0}.{1}&quot;, sectionName, key);
            }

            return XmlConvert.EncodeLocalName(sectionName);
        }

        public override void SetPropertyValues(SettingsContext context, SettingsPropertyValueCollection collection)
        {
            string sectionName = GetSectionName(context);
            IDictionary userSettings = new Hashtable();
            foreach (SettingsPropertyValue value in collection)
            {
                SettingsProperty setting = value.Property;
                if (value.IsDirty)
                {
                    StoredSetting ss = new StoredSetting(setting.SerializeAs, SerializeToXmlElement(setting, value));
                    userSettings[setting.Name] = ss;
                }
            }
            WriteSettings(sectionName, userSettings);
        }

        private void WriteSettings(string sectionName, IDictionary newSettings)
        {
            Open();
            var section = GetConfigSection(sectionName);

            if (section != null)
            {
                SettingElementCollection sec = section.Settings;
                foreach (DictionaryEntry entry in newSettings)
                {
                    SettingElement se = sec.Get((string)entry.Key);

                    if (se == null)
                    {
                        se = new SettingElement();
                        se.Name = (string)entry.Key;
                        sec.Add(se);
                    }

                    StoredSetting ss = (StoredSetting)entry.Value;
                    se.SerializeAs = ss.serializeAs;
                    se.Value.ValueXml = ss.xmlNode;
                }

                try
                {
                    configuration.Save();
                }
                catch (ConfigurationErrorsException ex)
                {
                    // We wrap this in an exception with our error message and throw again.
                    throw new ConfigurationErrorsException($&quot;Save file to {configuration.FilePath} failed&quot;, ex);
                }
            }
            else
            {
                throw new ConfigurationErrorsException($&quot;Can not find the section {section} in the setting file&quot;);
            }
        }

        private ClientSettingsSection GetConfigSection(string sectionName)
        {
            Configuration config = configuration;
            string fullSectionName = UserSettingsGroupName + &quot;/&quot; + sectionName;
            ClientSettingsSection section = null;

            if (config != null)
            {
                section = config.GetSection(fullSectionName) as ClientSettingsSection;

                if (section == null)
                {
                    // Looks like the section isn't declared - let's declare it and try again.
                    DeclareSection(sectionName);
                    section = config.GetSection(fullSectionName) as ClientSettingsSection;
                }
            }

            return section;
        }

        // Declares the section handler of a given section in its section group, if a declaration isn't already
        // present. 
        private void DeclareSection(string sectionName)
        {
            Configuration config = configuration;
            ConfigurationSectionGroup settingsGroup = config.GetSectionGroup(UserSettingsGroupName);

            if (settingsGroup == null)
            {
                //Declare settings group
                ConfigurationSectionGroup group = new UserSettingsGroup();
                config.SectionGroups.Add(UserSettingsGroupName, group);
            }

            settingsGroup = config.GetSectionGroup(UserSettingsGroupName);

            Debug.Assert(settingsGroup != null, &quot;Failed to declare settings group&quot;);

            if (settingsGroup != null)
            {
                ConfigurationSection section = settingsGroup.Sections[sectionName];
                if (section == null)
                {
                    section = new ClientSettingsSection();
                    section.SectionInformation.AllowExeDefinition = ConfigurationAllowExeDefinition.MachineToLocalUser;
                    section.SectionInformation.RequirePermission = false;
                    settingsGroup.Sections.Add(sectionName, section);
                }
            }
        }

        private XmlNode SerializeToXmlElement(SettingsProperty setting, SettingsPropertyValue value)
        {
            XmlDocument doc = new XmlDocument();
            XmlElement valueXml = doc.CreateElement(&quot;value&quot;);

            string serializedValue = value.SerializedValue as string;

            if (serializedValue == null &amp;&amp; setting.SerializeAs == SettingsSerializeAs.Binary)
            {
                // SettingsPropertyValue returns a byte[] in the binary serialization case. We need to
                // encode this - we use base64 since SettingsPropertyValue understands it and we won't have
                // to special case while deserializing.
                byte[] buf = value.SerializedValue as byte[];
                if (buf != null)
                {
                    serializedValue = Convert.ToBase64String(buf);
                }
            }

            if (serializedValue == null)
            {
                serializedValue = String.Empty;
            }

            // We need to escape string serialized values
            if (setting.SerializeAs == SettingsSerializeAs.String)
            {
                serializedValue = Escaper.Escape(serializedValue);
            }

            valueXml.InnerXml = serializedValue;

            // Hack to remove the XmlDeclaration that the XmlSerializer adds. 
            XmlNode unwanted = null;
            foreach (XmlNode child in valueXml.ChildNodes)
            {
                if (child.NodeType == XmlNodeType.XmlDeclaration)
                {
                    unwanted = child;
                    break;
                }
            }
            if (unwanted != null)
            {
                valueXml.RemoveChild(unwanted);
            }

            return valueXml;
        }

        private class XmlEscaper
        {
            private XmlDocument doc;
            private XmlElement temp;

            internal XmlEscaper()
            {
                doc = new XmlDocument();
                temp = doc.CreateElement(&quot;temp&quot;);
            }

            internal string Escape(string xmlString)
            {
                if (String.IsNullOrEmpty(xmlString))
                {
                    return xmlString;
                }

                temp.InnerText = xmlString;
                return temp.InnerXml;
            }

            internal string Unescape(string escapedString)
            {
                if (String.IsNullOrEmpty(escapedString))
                {
                    return escapedString;
                }

                temp.InnerXml = escapedString;
                return temp.InnerText;
            }
        }
    }
    internal class StoredSetting
    {
        public StoredSetting(SettingsSerializeAs serializeAs, XmlNode xmlNode)
        {
            this.serializeAs = serializeAs;
            this.xmlNode = xmlNode;
        }
        internal SettingsSerializeAs serializeAs;
        internal XmlNode xmlNode;
    }
</code></pre>
<p>ä¸»è¦çš„åœ°æ–¹åœ¨äºç»§æ‰¿<code>SettingsProvider</code>ç„¶åå®ç°ä¸¤ä¸ªå¿…é¡»å®ç°çš„æ–¹æ³•ï¼Œåˆ†åˆ«æ˜¯<code>public override SettingsPropertyValueCollection GetPropertyValues(SettingsContext context, SettingsPropertyCollection collection)</code>å’Œ<code>public override void SetPropertyValues(SettingsContext context, SettingsPropertyValueCollection collection)</code>ã€‚è¿™ä¸¤ä¸ªæ–¹æ³•ä¼šåœ¨è¯»å’Œå†™çš„æ—¶å€™è¢«è°ƒç”¨ã€‚ä¹‹å‰ä¹Ÿæåˆ°è¿‡ï¼Œæ¯æ¬¡è¯»å†™ï¼Œéƒ½ä¼šç”Ÿæˆä¸€ä¸ªæ–°çš„<code>SettingsProvider</code>çš„å®ä¾‹ï¼Œè¿™ç‚¹éœ€è¦æ³¨æ„ã€‚å…¶ä¸­ï¼ŒApplicationNameæ˜¯åœ¨å·¥ç¨‹è®¾ç½®é‡ŒAssmebly Informationä¸­çš„å€¼ã€‚<br>
å¯èƒ½è§£é‡Šå¾—ä¸æ˜¯å¾ˆæ¸…æ¥šï¼Œæœ‰ä»€ä¹ˆé—®é¢˜æ¬¢è¿ç•™è¨€ã€‚å½“ç„¶ï¼Œæ›´æ¨èå»çœ‹<code>LocalFileSettingsProvider</code>çš„æºç ã€‚</p>
 </p>
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-12 animate-box">
                        
                    </div>
                </div>

                <div class="row">
    <div class="col-md-12 animate-box">
        
            
                <div id="gitalk-container"></div>
            

            
        
    </div>
</div>

            </div>

        </article>
    </div>
</div>

    

    <!-- è¿”å›é¡¶éƒ¨ -->
    <div class="back-to-top">
    
        <a href="#!" id="tool-toc" class="hidden-xs hidden-sm">
            <i class="fa fa-map"></i>
        </a>
        <br>
    
    <a href="#top" class="hidden-xs hidden-sm"><i class="fa fa-paper-plane"></i></a>
</div>

<div class="post-toc animated fadeInRight hidden-xs hidden-sm" style="display: none;">
    <ul class="markdownIt-TOC">
<li><a href="#%E5%89%8D%E8%A8%80">å‰è¨€</a></li>
<li><a href="#%E4%BD%BF%E7%94%A8settings">ä½¿ç”¨Settings</a></li>
<li><a href="#%E5%B7%A5%E4%BD%9C%E6%B5%81%E7%A8%8B%E5%8F%8A%E5%8E%9F%E7%90%86%E7%AE%80%E8%BF%B0">å·¥ä½œæµç¨‹åŠåŸç†ç®€è¿°</a></li>
<li><a href="#%E8%87%AA%E5%AE%9A%E4%B9%89settingsprovider">è‡ªå®šä¹‰SettingsProvider</a></li>
</ul>

</div>


    
<footer id="fh5co-footer">
  <p>èœ€ICPå¤‡18034189å·-1</p>
</footer>


    <!-- jQuery -->
<script src="https://www.avaloninparadise.cn/media/scripts/jquery.min.js"></script>
<!-- img lazy load -->
<script src="https://www.avaloninparadise.cn/media/scripts/jquery.lazyload.min.js"></script>
<!-- jQuery Easing -->
<script src="https://www.avaloninparadise.cn/media/scripts/jquery.easing.1.3.js"></script>
<!-- Bootstrap -->
<script src="https://www.avaloninparadise.cn/media/scripts/bootstrap.min.js"></script>
<!-- Waypoints -->
<script src="https://www.avaloninparadise.cn/media/scripts/jquery.waypoints.min.js"></script>
<!-- Main JS -->
<script src="https://www.avaloninparadise.cn/media/scripts/main.js"></script>
<!-- Md5 Min JS -->
<script src="https://www.avaloninparadise.cn/media/scripts/md5.min.js"></script>
<!-- katex -->
<!--<script src="https://cdn.bootcss.com/KaTeX/0.11.1/katex.min.js"></script>-->
<!-- highlight -->
<script src="https://cdn.bootcss.com/highlight.js/9.15.8/highlight.min.js"></script>


<script type="application/javascript">
    // ä»£ç é«˜äº®
    hljs.initHighlightingOnLoad();

    // img æ‡’åŠ è½½
    $(function () {
        $("img.lazy").lazyload({
            effect: "fadeIn",  // æ‡’åŠ è½½åŠ¨ç”»
            threshold: 180  // åœ¨å›¾ç‰‡è·ç¦»å±å¹•180pxæ—¶æå‰è½½å…¥
        });
        // tooltip
        $('[data-toggle="tooltip"]').tooltip();

        // ç›®å½•
        $('#tool-toc').click(function () {
            $('.post-toc').toggle();
        });
    });

    
</script>



    
        <script src="https://cdn.bootcss.com/gitalk/1.5.0/gitalk.min.js"></script>
        <script>

            var gitalk = new Gitalk({
                clientID: 'da4ce1950c04e8a84b86',
                clientSecret: '218cc92d3af98096d7e1754ffae1bb8580b7ba65',
                repo: 'https://github.com/wunianqing/GittalkForMyBlog.git',
                owner: 'yzhou',
                admin: ['yzhou'],
                id: md5(location.pathname),      // Ensure uniqueness and length less than 50
                distractionFreeMode: false  // Facebook-like distraction free mode
            })

            gitalk.render('gitalk-container')

        </script>
    

    




</body>
</html>
